/*! js/dom_search.js,js/shinpachi_console.js 2014-09-18 */
!function(a,b){var c=function(b){this.dom_element=b,this.search=function(b){var c;if(b.constructor===RegExp?c=b:b.constructor===String&&(c=new RegExp(b,"i")),void 0===c)return null;var d=function(a){if(0===a.childNodes.length){if(null===a.nextSibling){for(var b=a.parentNode;b!==g.dom_element&&null===b.nextSibling;)b=b.parentNode;return b===g.dom_element?null:b.nextSibling}return a.nextSibling}return a.childNodes[0]},e=this.dom_element,f=0,g=this,h=function(){var b=null,g=!0,h=f;f=0,e.nodeType===a.TEXT_NODE&&(b=e.nodeValue.slice(h).match(c),null!==b&&(next_idx=b.index+h+b[0].length,next_idx<e.nodeValue.length&&(g=!1,f=next_idx)));var i;return null===b?i=null:(b.index=b.index+h,i={elem:e,match:b}),g&&(e=d(e)),i},i=function(){for(var a=null;null!==e&&(a=h(),null===a););return a};return i}};b.Searcher=c}(document,window),function(a){var b,c,d,e={},f={},g={},h=new RegExp("^(OPTIONS|GET|HEAD|POST|PUT|DELETE|TRACE|CONNECT) +([^ ]+) +HTTP/([0-9.]+)\r\n"),i=new RegExp("^HTTP/([0-9.]+) +([0-9]+) +(.+)\r\n"),j=new RegExp("^(([0-9]+(\\.[0-9]+){3})|\\[([:0-9a-fA-F]+)\\]):([0-9]+)-(([0-9]+(\\.[0-9]+){3})|\\[([:0-9a-fA-F]+)\\]):([0-9]+):\r\n"),k=new RegExp("^([0-9]{1,3}(\\.[0-9]{1,3}){3})(:[0-9]{1,5}){0,1}$"),l=new RegExp("^([0-9a-fA-F]{0,4}(\\:[0-9a-fA-F]{1,4}){0,7})(\\:?)((\\:[0-9a-fA-F]{1,4}){1,7})$"),m=new RegExp("^\\[([0-9a-fA-F]{0,4}(\\:[0-9a-fA-F]{1,4}){0,7})(\\:?)((\\:[0-9a-fA-F]{1,4}){1,7})\\]\\:([0-9]{1,5})$"),n=!1,o=!1,p=[{re:"^text/html$",langs:["html","json","javascript"]},{re:"^text/css$",langs:["css"]},{re:"^application/x-www-form-urlencoded$",langs:["http"]},{re:"javascript",langs:["javascript"]},{re:"json",langs:["json"]},{re:"^text/",langs:hljs.listLanguages()}],q=function(a){for(var b=0;b<p.length;b++)if(null!==a.match(p[b].re))return p[b].langs;return void 0},r=function(a){return"object"==typeof a?null===a?"null":a.constructor==(new Array).constructor?"array":a.constructor==(new Date).constructor?"date":a.constructor==(new RegExp).constructor?"regex":"object":typeof a},s=function(b,c){if(arguments.length<2)var c="";var d="    ",e=r(b);if("array"==e){if(0==b.length)return"[]";var f="["}else{var g=0;if(a.each(b,function(){g++}),0==g)return"{}";var f="{"}var g=0;return a.each(b,function(a,b){switch(g>0&&(f+=","),f+="array"==e?"\n"+c+d:"\n"+c+d+'"'+a+'": ',r(b)){case"array":case"object":f+=s(b,c+d);break;case"boolean":case"number":f+=b.toString();break;case"null":f+="null";break;case"string":f+='"'+b+'"';break;default:f+="TYPEOF: "+typeof b}g++}),f+="array"==e?"\n"+c+"]":"\n"+c+"}"},t=function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=255&a.charCodeAt(c);return b.buffer},u=function(a){return a.indexOf(":")>=0?"["+a+"]":a},v=function(a,b){a.appendChild(document.createTextNode(b))},w=function(a){for(var b,c=a.split(";"),d=c[0],e={},f=1;f<c.length;f++)b=c[f].trim().split("="),e[b[0]]=b[1];return{content_type:d,params:e}},x=function(a,b){var c,d;return c=document.createElement(a),d=document.createElement("span"),v(d,b),c.appendChild(d),c},y=function(a){return a%2===0?"odd":"even"},z=function(a,b,c){var d=document.createElement("li"),e=document.createElement("span"),f=document.createElement("span"),g=document.createElement("div");return d.className=y(c),g.className="line",e.className="label",f.className="content",v(e,a),v(f,b),g.appendChild(e),g.appendChild(f),d.appendChild(g),d},A=function(a){var b,c,d,e=0;return b=document.createElement("ul"),d=u(a.src_addr)+":"+a.src_port,c=z("Source",d,e++),b.appendChild(c),d=u(a.dst_addr)+":"+a.dst_port,c=z("Destination",d,e++),b.appendChild(c),b},B=function(a){var b=document.createElement("pre");b.className="raw-data-hex";var c=document.createElement("code"),d=document.createTextNode(""),e=document.createElement("pre");e.className="raw-data-txt";var f=document.createElement("code"),g=document.createTextNode(""),h=new FileReader;return h.addEventListener("loadend",function(){for(var a,b,c=new Uint8Array(h.result),e="",f="",i=0;i<c.length;i++)a=(c[i]+256).toString(16).substr(-2).toUpperCase(),b=c[i]>=32&&c[i]<=126?String.fromCharCode(c[i]):".",(i+1)%16===0?(a+="\n",b+="\n"):a+=(i+1)%8===0?"  ":" ",e+=a,f+=b;d.nodeValue=e,g.nodeValue=f}),h.readAsArrayBuffer(a),c.appendChild(d),b.appendChild(c),f.appendChild(g),e.appendChild(f),{hex:b,txt:e}},C=function(b,c){var d=document.createElement("div");d.className="stream-content";var e=!1;if(null!==c){c=c.toLowerCase();var f=w(c);if(null!==f.content_type.match(/^image\//)){var g=document.createElement("img");d.appendChild(g);var h=new Blob([b],{type:f.content_type}),i=new FileReader;i.addEventListener("loadend",function(){g.src=i.result}),i.readAsDataURL(h)}else{var j=q(f.content_type);if(void 0!==j){var k=f.params.charset?f.params.charset:"utf-8",l=document.createElement("pre"),m=document.createElement("code"),n=new Blob([b],{type:f.content_type}),i=new FileReader;i.addEventListener("loadend",function(){var b=i.result;if(null!==f.content_type.match(/json/))try{b=s(JSON.parse(b))}catch(c){b=i.result}v(m,b);var d=a(m);d.data("content_need_hl","true"),d.data("content_type",f.content_type)}),l.appendChild(m),d.appendChild(l),i.readAsText(n,k)}else e=!0}}else e=!0;if(e){var o=B(b);d.appendChild(o.hex),d.appendChild(o.txt)}return d},D=function(a,b){var c,d,e;e=document.createElement("div"),e.className="stream-content",c=document.createElement("ul"),d=document.createElement("li"),d.className=y(0);var f=B(b);return e.appendChild(f.hex),e.appendChild(f.txt),d.appendChild(e),c.appendChild(d),c},E=function(a){var b,c,d,e,f,g=0;b=document.createElement("ul"),c=z("Status",a.status+" "+a.status_str,g++),b.appendChild(c),c=z("HTTP Version",a.version,g++),b.appendChild(c),c=document.createElement("li"),c.className=y(0),d=x("h2","Headers"),c.appendChild(d),e=document.createElement("ul");for(var h,i,j=null,k=0;k<a.headers.length;k++)h=a.headers[k][0],i=a.headers[k][1],f=z(h,i,k),e.appendChild(f),"CONTENT-TYPE"===h&&(j=i);if(c.appendChild(e),b.appendChild(c),a.content.size>0){c=document.createElement("li"),c.className=y(0),d=x("h2","Content"),c.appendChild(d);var l=C(a.content,j);c.appendChild(l),b.appendChild(c)}return b},F=function(a){var b,c,d,e,f,g=0;b=document.createElement("ul"),c=z("Method",a.method,g++),b.appendChild(c);var h,i,j;h=a.path.split("?"),i=h[0],j=h.slice(1).join("?"),c=z("Path",i,g++),b.appendChild(c),j.length>0&&(c=z("Query String",j,g++),b.appendChild(c)),c=z("HTTP Version",a.version,g++),b.appendChild(c),c=document.createElement("li"),c.className=y(0),d=x("h2","Headers"),c.appendChild(d),e=document.createElement("ul");for(var k,l,m=null,n=0;n<a.headers.length;n++)k=a.headers[n][0],l=a.headers[n][1],f=z(k,l,n),e.appendChild(f),"CONTENT-TYPE"===k&&(m=l);if(c.appendChild(e),b.appendChild(c),a.content.size>0){c=document.createElement("li"),c.className=y(0),d=x("h2","Content"),c.appendChild(d);var o=C(a.content,m);c.appendChild(o),b.appendChild(c)}return b},G=function(a){void 0!==a&&(a.pinned=!0)},H=function(a){void 0!==a&&delete a.pinned},I=function(a,b){var c,d,e;if("http-req"===a.type?(d=u(a.dst_addr)+":"+a.dst_port,e=u(a.src_addr)+":"+a.src_port,c=d+"-"+e):"http-rep"===a.type?(d=u(a.src_addr)+":"+a.src_port,e=u(a.dst_addr)+":"+a.dst_port,c=d+"-"+e):(d=u(a.src_addr)+":"+a.src_port,e=u(a.dst_addr)+":"+a.dst_port,c=null),null!==c)return void 0===f[c]&&b===!0&&(f[c]=new Array),f[c];var g=d+"-"+e,h=e+"-"+d;return void 0!==f[g]?f[g]:void 0!==f[h]?f[h]:(b===!0&&(f[h]=new Array),f[h])},J=function(a,b){var c=document.createElement("div");return c.className="event-detail",c.appendChild(x("h1","Network")),c.appendChild(A(a)),"http-req"===a.type?(c.appendChild(x("h1","HTTP Request")),c.appendChild(F(a))):"http-rep"===a.type?(c.appendChild(x("h1","HTTP Response")),c.appendChild(E(a))):(c.appendChild(x("h1","Raw Data")),c.appendChild(D(a,b))),c},K=function(d){var e,f,g=d.stream;if(void 0!==g)if("http-req"===g.type)e=g.request_line,f="http-request";else if("http-rep"===g.type){e=g.status_line;var h=g.status.slice(0,1);f="2"===h?"http-reply status-2xx":"3"===h?"http-reply status-3xx":"4"===h?"http-reply status-4xx":"5"===h?"http-reply status-5xx":"http-reply"}else e="Raw Data",f="raw-data";else e=d.brief_desc,f=d["class"];var i,j,k=document.createElement("div"),l=document.createElement("div"),m=document.createElement("div"),p=new Date;if(m.appendChild(document.createTextNode(e)),m.className="event-content "+f,l.appendChild(document.createTextNode((p-b)/1e3)),l.className="event-time",k.className="event-list-item",k.appendChild(l),k.appendChild(m),void 0!==g){i=document.createElement("div"),i.className="side-buttons",k.appendChild(i),j=a(i);var r=document.createElement("i");r.className="fa fa-thumb-tack side-button pin-button",pin_button_obj=a(r),pin_button_obj.click(function(b){b.stopPropagation();var c=I(g,!1);if(void 0!==c)if(c.pinned===!0){H(c);for(var d=0;d<c.length;d++)a(c[d].getElementsByClassName("pin-button")[0]).removeClass("down")}else{G(c);for(var d=0;d<c.length;d++)a(c[d].getElementsByClassName("pin-button")[0]).addClass("down")}});var s=document.createElement("i");s.className="fa fa-chevron-down side-button flow-button-down";var t=a(s);t.click(function(b){b.stopPropagation();for(var c=b.clientY,d=a(k).position().top,e=I(g,!1),f=0;f<e.length;f++)if(e[f]===k&&f+1<e.length){var h=a(e[f+1]),i=h.position().top;h.data("detail_shown")!==!0&&h.click(),window.scrollTo(0,d-c+(i-d)+h.height()/2);break}});var u=document.createElement("i");u.className="fa fa-chevron-up side-button flow-button-up";var v=a(u);v.click(function(b){b.stopPropagation();for(var c=b.clientY,d=a(k).position().top,e=I(g,!1),f=0;f<e.length;f++)if(e[f]===k&&f-1>=0){var h=a(e[f-1]),i=h.position().top;h.data("detail_shown")!==!0&&h.click(),window.scrollTo(0,d-c-(d-i)+h.height()/2);break}}),i.appendChild(u),i.appendChild(s),i.appendChild(r)}if(c.appendChild(k),void 0!==g){var w=J(g,d.raw_data);c.appendChild(w);var x=function(){j.show();var b=I(g,!1);if(void 0!==b)for(var c=0;c<b.length;c++)a(b[c].getElementsByClassName("event-content")[0]).addClass("highlighted")},y=function(){j.hide();var b=I(g,!1);if(void 0!==b&&b.pinned!==!0)for(var c=0;c<b.length;c++)a(b[c].getElementsByClassName("event-content")[0]).removeClass("highlighted")},z=a(k);z.mouseenter(x),z.mouseleave(y),z.click(function(b){b.stopPropagation();var c=a(w);if(c.toggle(),"none"===c.css("display")?z.data("detail_shown","false"):z.data("detail_shown","true"),"none"!==c.css("display"))for(var d,e,f,g=w.getElementsByTagName("code"),h=0;h<g.length;h++)d=a(g[h]),void 0===d.data("highlighted")&&d.data("content_need_hl")===!0&&(d.data("highlighted","true"),e=d.data("content_type"),f=q(e),hljs.configure(void 0===f?{languages:hljs.listLanguages()}:{languages:f}),hljs.highlightBlock(g[h]))})}return n===!0&&(o=!0,k.scrollIntoView(!0)),k},L=function(){var a,b=window.location;return a="https:"===b.protocol?"wss://":"ws://",a+="/"!==b.pathname[b.pathname.length-1]?b.host+b.pathname+"/ws":b.host+b.pathname+"ws"},M=function(a,b){var c=I(a,!0);c.push(b)},N=function(a){if(header_end=a.indexOf("\r\n\r\n"),header_end>=0){var b=header_end+"\r\n\r\n".length,c=a.slice(0,b),d=a.slice(b);c=c.split("\r\n");for(var e=new Array,f=0;f<c.length;f++)c[f].length<=0||(hs=c[f].split(":"),hname=hs[0].trim(),hval=hs.slice(1).join(":").trim(),e.push([hname,hval]));var g=new Blob([t(d)]);return{headers:e,content:g}}return null},O=function(a){var b=a.match(j);if(null===b)return console.log(b),null;var c=b[0],d=!1;if(a=a.slice(c.length),a.length>0)if(void 0===e[c]){var f=b[2]?b[2]:b[4],g=b[5],k=b[7]?b[7]:b[9],l=b[10];if(req_match=a.match(h),null!==req_match){var m=req_match[0];a=a.slice(m.length);var n=N(a);null!==n&&(e[c]={type:"http-req",topic:c,src_addr:f,src_port:g,dst_addr:k,dst_port:l,request_line:m,method:req_match[1],path:req_match[2],version:req_match[3],headers:n.headers,content:n.content})}else if(rep_match=a.match(i),null!==rep_match){var o=rep_match[0];a=a.slice(o.length);var n=N(a);null!==n&&(e[c]={type:"http-rep",topic:c,src_addr:f,src_port:g,dst_addr:k,dst_port:l,status_line:o,status:rep_match[2],status_str:rep_match[3],version:rep_match[1],headers:n.headers,content:n.content})}else e[c]={type:"raw",topic:c,src_addr:f,src_port:g,dst_addr:k,dst_port:l},d=!0}else{var p=e[c].type;"http-req"===p||"http-rep"===p?e[c].content=new Blob([e[c].content,t(a)]):d=!0}else if(void 0!==e[c]){var p=e[c].type;("http-req"===p||"http-rep"===p)&&(d=!0)}return{topic:c,complete:d}},P=function(b){b.onopen=function(){K({"class":"local-msg",brief_desc:"Connected."}),a.ajax({type:"GET",url:"proxy.json",success:function(a){var b=a.http_proxies[0].host,c=a.http_proxies[0].port;K({"class":"local-msg",brief_desc:"HTTP proxy running at "+b+":"+c})},error:function(){K({"class":"local-msg",brief_desc:"Failed to locate the proxy server."})}})},b.onmessage=function(a){var b=new FileReader;b.addEventListener("loadend",function(){var a=b.result,c=O(a);if(null===c)return void console.log(a);if(c.complete){var d=e[c.topic],f=u(d.src_addr),h=u(d.dst_addr),i=f+":"+d.src_port,j=h+":"+d.dst_port,k=!1;for(var l in g)if("trigger"===g[l].type){if(f===g[l].ep1||h===g[l].ep1||i===g[l].ep1||j===g[l].ep1){k=!0;break}}else{for(var m=[[f,h],[h,f],[i,h],[h,i],[f,j],[j,f],[i,j],[j,i]],n=0;n<m.length;n++)if(m[n][0]===g[l].ep1&&m[n][1]===g[l].ep2){k=!0;break}if(k===!0)break}if(k){var o;if("http-req"===d.type)o=K({stream:d});else if("http-rep"===d.type)o=K({stream:d});else{var p=a.slice(d.topic.length);o=K({stream:d,raw_data:new Blob([t(p)])})}M(d,o),delete e[c.topic]}}}),b.readAsBinaryString(a.data)},b.onerror=function(a){console.log(a)},b.onclose=function(a){K({"class":"local-msg",brief_desc:"Disconnected, code = "+a.code+", reason = "+a.reason})},d=b},Q=function(){var b=a("#subscribe-panel"),e=a("#subscribe-button"),h=a("#endpoint1"),i=a("#endpoint2"),j=a("#subs-submit-button");a("#subscribe-panel > .panel-title > .close-button").click(function(){e.click()}),a('#subscribe-panel > input[type="text"]').focus(function(){this.select()}),e.click(function(){"none"!==b.css("display")?(b.hide(),e.removeClass("down")):(a(".toolbar-panel").hide(),a("#cmd-list > li").removeClass("down"),b.show(),e.addClass("down"),h.focus())});var p=function(a){if(null===a.match(k)){var b=a.match(l);if(null===b){var c=a.match(m);if(null===c)return null;var d=(c[1]+c[4]).split(":");return":"===c[3]&&d.length>7?null:""===c[3]&&8!==d.length?null:"ipv6_ip_port"}var d=(b[1]+b[4]).split(":");return":"===b[3]&&d.length>7?null:""===b[3]&&8!=d.length?null:"ipv6_ip_only"}return"ipv4"},q=function(b){b.stopPropagation();var c=a(this),d=c.val(),e=p(d);d.length<=0||null!==e?c.removeClass("error"):c.addClass("error")},r=function(a){a.stopPropagation(),(13===a.keyCode||10===a.keyCode)&&j.click()};h.on("input",q),i.on("input",q),h.keypress(r),i.keypress(r);var s=function(a,b){return"ipv6_ip_only"===b?"["+a+"]":a};j.click(function(b){b.stopPropagation();var c,f,j,k=h.val().trim(),l=i.val().trim(),m=p(k),n=p(l),o=a("#subscribe-message-content"),q=a("#subscribe-panel > .subscribe-message");return null!==m&&null!==n?(k=s(k,m),l=s(l,n),c="subscribe "+k+" "+l,f="subscribe "+l+" "+k,void 0!==g[c]||void 0!==g[f]?(e.click(),void q.hide()):(j={type:"subscribe",ep1:k,ep2:l},g[c]=j,d.send(c),e.click(),void q.hide())):null!==m&&null===n&&0===l.length?(k=s(k,m),c="trigger "+k,void 0!==g[c]?(e.click(),void q.hide()):(j={type:"trigger",ep1:k},g[c]=j,d.send(c),e.click(),void q.hide())):null!==n&&null===m&&0===k.length?(l=s(l,n),c="trigger "+l,void 0!==g[c]?(e.click(),void q.hide()):(j={type:"trigger",ep1:l},g[c]=j,d.send(c),e.click(),void q.hide())):0===k.length&&0===l.length?(o.html("All endpoints are empty"),void q.show()):(o.html("Illegal endpoint specification"),void q.show())});var t=a("#subscription-list-button"),u=a("#subs-list-panel");a("#subs-list-panel > .panel-title > .close-button").click(function(){t.click()}),t.click(function(){if("none"!==u.css("display"))u.hide(),t.removeClass("down");else{a(".toolbar-panel").hide(),a("#cmd-list > li").removeClass("down"),a(".subs-list-item").remove();var b,c,e;for(var f in g)b=document.createElement("span"),b.className="subs-list-item",e="trigger"===g[f].type?g[f].ep1:g[f].ep1+" - "+g[f].ep2,v(b,e),b.title="Unsubscribe",c=a(b),c.data("subs_cmd_name",f),c.click(function(){var b=a(this),c=b.data("subs_cmd_name"),e=c.split(" ").slice(1);d.send("unsubscribe "+e.join(" ")),b.remove(),delete g[c]}),u[0].appendChild(b);u.show(),t.addClass("down")}});var w=a("#search-button"),x=(a("#search-input"),a("#search-text"));x.keypress(function(a){console.log(a),(13===a.keyCode||10===a.keyCode)&&console.log("Enter pressed")}),x.focus(function(){this.select()});var y=a("#clear-log-button");y.click(function(){f={},c.innerHTML="",K({"class":"local-msg",brief_desc:"Logs cleared."})});var z=a("#re-connect-button");z.click(function(){if(void 0!==d){d.onclose=void 0,d.close(),g={};var a=L(),b=new WebSocket(a);K({"class":"local-msg",brief_desc:"Re-connecting to Shinpachi...."}),P(b)}});var A=a("#open-all-button");A.click(function(){a("#event-list > .event-detail").hide(),a("#event-list > .event-list-item").each(function(b,c){a(c).click()})});var B=a("#close-all-button");B.click(function(){a("#event-list > .event-detail").hide(),a("#event-list > .event-list-item").data("detail_shown","false")});var C=a("#follow-event-button");C.click(function(){C.hasClass("down")?(n=!1,C.removeClass("down")):(n=!0,C.addClass("down"),o=!0,a("#event-list > .event-list-item").last()[0].scrollIntoView(!0))}),a(window).scroll(function(){return o===!0?void(o=!1):void(C.hasClass("down")&&C.click())});var D={83:function(){e.click()},115:function(){e.click()},76:function(){t.click()},108:function(){t.click()},47:function(){w.click()},67:function(){y.click()},99:function(){y.click()},82:function(){z.click()},114:function(){z.click()},43:function(){A.click()},45:function(){B.click()},70:function(){C.click()},102:function(){C.click()}};a("body").keypress(function(a){if(!a.ctrlKey&&!a.altKey){var b=D[a.charCode];void 0!==b&&(a.preventDefault(),b())}})},R=function(){c=document.getElementById("event-list");var a=L(),d=new WebSocket(a);b=new Date,K({"class":"local-msg",brief_desc:"Connecting to Shinpachi...."}),Q(),P(d)};a(R)}(Zepto);